<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Telegram WebApp Debug</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            background: #f5f5f5;
            max-width: 600px;
            margin: 0 auto;
        }
        button {
            background: #2e7aff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
        }
        pre {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .data-block {
            margin: 15px 0;
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #2e7aff;
        }
        .label {
            font-weight: bold;
            color: #666;
            margin-bottom: 5px;
        }
    </style>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
<h2>üîç Telegram WebApp Debug</h2>

<div class="data-block">
    <div class="label">üì± Telegram WebApp –¥–∞–Ω–Ω—ã–µ:</div>
    <pre id="telegramData">–ó–∞–≥—Ä—É–∑–∫–∞...</pre>
</div>

<button id="loginBtn">üöÄ –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram</button>

<div class="data-block">
    <div class="label">üì° –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:</div>
    <pre id="serverResponse">‚Äî</pre>
</div>

<div class="data-block">
    <div class="label">üë§ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (currentUser):</div>
    <pre id="userData">‚Äî</pre>
</div>

<div class="data-block">
    <div class="label">üîë –¢–æ–∫–µ–Ω:</div>
    <pre id="tokenData">‚Äî</pre>
</div>

<div class="data-block">
    <div class="label">üìã –ß—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ reminder:</div>
    <pre id="reminderData">‚Äî</pre>
</div>

<button id="testReminderBtn" disabled>üíä –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞</button>
<pre id="reminderResponse">‚Äî</pre>

<script>
    const API_BASE = 'https://medicine-reminder-app-t3u9.onrender.com/api';
    let currentUser = null;
    let authToken = null;

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Telegram
    function showTelegramData() {
        const tg = window.Telegram?.WebApp;
        const data = {
            hasTelegram: !!tg,
            initData: tg?.initData || '‚Äî',
            initDataUnsafe: tg?.initDataUnsafe || '‚Äî',
            user: tg?.initDataUnsafe?.user || '‚Äî'
        };
        document.getElementById('telegramData').textContent = JSON.stringify(data, null, 2);
        console.log('Telegram Data:', data);
    }

    // –í—Ö–æ–¥ —á–µ—Ä–µ–∑ Telegram
    async function loginWithTelegram() {
        const tg = window.Telegram?.WebApp;
        if (!tg || !tg.initData) {
            alert('–≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç–æ —á–µ—Ä–µ–∑ Telegram WebApp!');
            return;
        }

        document.getElementById('serverResponse').textContent = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞...';

        try {
            const response = await fetch(`${API_BASE}/auth/telegram`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ initData: tg.initData })
            });

            const data = await response.json();
            document.getElementById('serverResponse').textContent = JSON.stringify(data, null, 2);
            console.log('Server response:', data);

            if (response.ok) {
                authToken = data.token;
                currentUser = data.user;

                document.getElementById('userData').textContent = JSON.stringify(currentUser, null, 2);
                document.getElementById('tokenData').textContent = authToken;

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –±—É–¥–µ–º –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –≤ reminder
                const reminderPayload = {
                    userId: currentUser.id,  // —Ç–æ, —á—Ç–æ —Å–µ–π—á–∞—Å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è
                    medicineId: 1,
                    reminderTime: '08:30',
                    daysOfWeek: 'everyday'
                };
                document.getElementById('reminderData').textContent = JSON.stringify(reminderPayload, null, 2);

                document.getElementById('testReminderBtn').disabled = false;
            }
        } catch (err) {
            document.getElementById('serverResponse').textContent = '‚ùå –û—à–∏–±–∫–∞: ' + err.message;
            console.error(err);
        }
    }

    // –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞
    async function testCreateReminder() {
        if (!currentUser || !authToken) return;

        const payload = {
            userId: currentUser.id,
            medicineId: 1,
            reminderTime: '08:30',
            daysOfWeek: 'everyday'
        };

        document.getElementById('reminderResponse').textContent = '‚è≥ –°–æ–∑–¥–∞–Ω–∏–µ...';

        try {
            const response = await fetch(`${API_BASE}/reminders`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify(payload)
            });

            const data = await response.json();
            document.getElementById('reminderResponse').textContent = JSON.stringify(data, null, 2);
            console.log('Reminder response:', data);

            if (!response.ok) {
                alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è: ' + (data.message || response.status));
            } else {
                alert('‚úÖ –ü—Ä–µ–ø–∞—Ä–∞—Ç —Å–æ–∑–¥–∞–Ω! ID: ' + data.id);
            }
        } catch (err) {
            document.getElementById('reminderResponse').textContent = '‚ùå –û—à–∏–±–∫–∞: ' + err.message;
            console.error(err);
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', () => {
        showTelegramData();

        document.getElementById('loginBtn').addEventListener('click', loginWithTelegram);
        document.getElementById('testReminderBtn').addEventListener('click', testCreateReminder);
    });
</script>
</body>
</html>